# 03 Mongo deploy

In this example we are going to learn how to deploy MongoDB.

We will start from `02-manual-heroku-deploy`.

# Steps to build it

`npm install` to install previous sample packages:

```bash
cd front
npm install

```

In a second terminal:

```bash
cd back
npm install

```

Once we have the app deployed in Heroku in API mock mode and it's working, we will deploy the MongoDB in this case in [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) the official cloud site.

We could start at free cluster:

![00-start-free-cluster](./readme-resources/00-start-free-cluster.png)

We could select between three providers and different regions:

![01-select-provider-and-region](./readme-resources/01-select-provider-and-region.png)

Select the cluster tier, in this case `M0 Sandbox` which it's a free tier with No backup:

![02-select-cluster-tier](./readme-resources/02-select-cluster-tier.png)

Finally, give a name (if you want) and create the cluster:

![03-create-cluster](./readme-resources/03-create-cluster.png)

This is the main cluster page, where we will see:

- Configure Network Access.
- Configure Database Access.
- See mongo connection URI.
- See collections and documents.

![04-main-cluster-page](./readme-resources/04-main-cluster-page.png)

By default, MongoDB Atlas only allows access to configured IPs, let's add a new rule to allow all IPs:

![05-configure-network-access](./readme-resources/05-configure-network-access.png)

Let's configure database access, adding new user:

![06-configure-database-access](./readme-resources/06-configure-database-access.png)

> Let's copy the autogenerated password. We will use in the MongoDB Connection URI

Let's copy the `MongoDB Connection URI`:

![07-click-connect-button](./readme-resources/07-click-connect-button.png)

![08-copy-connection-uri](./readme-resources/08-copy-connection-uri.png)

Update env variable:

_./back/.env_

```diff
NODE_ENV=development
PORT=3000
STATIC_FILES_PATH=../public
CORS_ORIGIN=*
CORS_METHODS=GET,POST,PUT,DELETE
API_MOCK=true
- MONGODB_URI=mongodb://localhost:27017/book-store
+ MONGODB_URI=mongodb+srv://<user>:<password>@<cluster>.mongodb.net/book-store?retryWrites=true&w=majority
AUTH_SECRET=MY_AUTH_SECRET
AWS_ACCESS_KEY_ID=value
AWS_SECRET_ACCESS_KEY=value
AWS_S3_BUCKET=lemoncode-book-store-bucket

```

> Replace <user>, <password> and <cluster> with MongoDB Atlas provided values.

Now, we will insert users's documents in `production` database:

_./back/src/console-runners/seed-data.runner.ts_

```diff
import { disconnect } from 'mongoose';
import { connectToDBServer } from 'core/servers';
import { envConstants } from 'core/constants';
import { bookContext } from 'dals/book/book.context';
import { userContext } from 'dals/user/user.context';
import { db } from 'dals/mock-data';
import { generateSalt, hashPassword } from 'common/helpers';

export const run = async () => {
  await connectToDBServer(envConstants.MONGODB_URI);

  for (const user of db.users) {
    const salt = await generateSalt();
    const hashedPassword = await hashPassword(user.password, salt);

    await userContext.insertMany({
      ...user,
      password: hashedPassword,
      salt,
    });
  }

- await bookContext.insertMany(db.books);
  await disconnect();
};

```

Run `console-runner`:

_back terminal_

```bash
npm run start:console-runners
```

Check result in MongoDB Atlas:

![09-click-collections-button](./readme-resources/09-click-collections-button.png)

![10-mongo-collections](./readme-resources/10-mongo-collections.png)

Restore local env variable:

_./back/.env_

```diff
NODE_ENV=development
PORT=3000
STATIC_FILES_PATH=../public
CORS_ORIGIN=*
CORS_METHODS=GET,POST,PUT,DELETE
API_MOCK=true
- MONGODB_URI=mongodb+srv://<user>:<password>@<cluster>.mongodb.net/book-store?retryWrites=true&w=majority
+ MONGODB_URI=mongodb://localhost:27017/book-store
AUTH_SECRET=MY_AUTH_SECRET
AWS_ACCESS_KEY_ID=value
AWS_SECRET_ACCESS_KEY=value
AWS_S3_BUCKET=lemoncode-book-store-bucket

```

Finally, we will update Heroku env variables using `production MONGODB_URI` value:

![11-update-heroku-env-variables](./readme-resources/11-update-heroku-env-variables.png)

Since we didn't insert any book, we could use deployed app, to insert one and see the result in MongoDB Atlas:

![12-insert-book-from-deployed-app](./readme-resources/12-insert-book-from-deployed-app.png)

![13-check-documents](./readme-resources/13-check-documents.png)

# ¿Con ganas de aprender Backend?

En Lemoncode impartimos un Bootcamp Backend Online, centrado en stack node y stack .net, en él encontrarás todos los recursos necesarios: clases de los mejores profesionales del sector, tutorías en cuanto las necesites y ejercicios para desarrollar lo aprendido en los distintos módulos. Si quieres saber más puedes pinchar [aquí para más información sobre este Bootcamp Backend](https://lemoncode.net/bootcamp-backend#bootcamp-backend/banner).
